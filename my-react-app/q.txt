-- Tracks which lessons a user has completed
create table user_lesson_progress (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references auth.users(id) on delete cascade not null,
  source_language text not null,
  target_language text not null,
  lesson_id text not null,      
  completed_at timestamptz default now(),
  unique(user_id, source_language, target_language, lesson_id)
);

alter table user_lesson_progress enable row level security;

create policy "users can manage own progress"
  on user_lesson_progress for all using (auth.uid() = user_id);

-- Optional: index for fast lookups per user+language pair
create index on user_lesson_progress(user_id, source_language, target_language);





create table profiles (
  user_id uuid references auth.users(id) on delete cascade primary key,
  username text,
  source_language text default 'Python',
  target_language text default 'Rust',
  xp int default 0,
  current_streak int default 0,
  longest_streak int default 0,
  last_completed_date date
  lesson_id text not null,      
  completed_at timestamptz default now(),
  unique(user_id, source_language, target_language, lesson_id)
);

create table profiles (
  user_id uuid references auth.users(id) on delete cascade primary key,
  username text,
  source_language text default 'Python',
  target_language text default 'Rust',
  xp int default 0,
  current_streak int default 0,
  longest_streak int default 0,
  last_completed_date date
);

create table completed_lessons (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references profiles(user_id) on delete cascade,
  lesson_id text not null,
  completed_at timestamptz default now(),
  unique(user_id, lesson_id)
);


---------------------------------------------------------

drop table completed_lessons;

create table completed_lessons (
  id uuid default gen_random_uuid() primary key,
  user_id uuid references profiles(user_id) on delete cascade,
  lesson_id text not null,
  source_language text not null default 'Python',
  target_language text not null default 'Rust',
  completed_at timestamptz default now(),
  unique(user_id, source_language, target_language, lesson_id)
);

alter table completed_lessons enable row level security;

create policy "users can manage own lessons"
  on completed_lessons for all using (auth.uid() = user_id);

